<!DOCTYPE html>
<html>
  <head>
    <title>Google Vacation Rental Calculator</title>
    <style>
      .example-results {
        border: 2px solid #0a64b8;
        color: black;
        display: flex;
        font-family: sans-serif;
        font-weight: bold;
		display: flex;
		flex-direction: column;
      }

      .example-parent {
        border: 2px solid #DFA612;
        color: black;
        display: flex;
        font-family: sans-serif;
        font-weight: bold;
      }

      .example-origin {
        flex-basis: 50%;
        flex-grow: 1;
        padding: 10px;
		display: flex;
		flex-flow: column;		
      }

      .example-draggable {
        background-color: #4AAE9B;
        font-weight: normal;
        margin-bottom: 10px;
        margin-top: 10px;
        padding: 10px;
      }

      .example-dropzone {
		display: flex;
		justify-content: center;
		flex-flow: column;
        background-color: hsl(138, 100%, 50%);
        flex-basis: 100%;
        flex-grow: 1;
        padding: 10px;
      }
	  
	  .example-dropzone:hover {
		font-weight: bold;
		color: yellow;
		background-color: hsl(240, 100%, 50%);
	  }
	  
	  .spacer {
		height: 1rem;
	  }
	  
	  .headerDetail {
		background-color: hsl(80, 50%, 50%);
	  }
	  
	  .bigHeaderDetail {
		background-color: hsl(45, 50%, 50%);
	  }
	  
        .container {
            border: 1px solid grey;
            margin: 1rem;
        }
 
        [data-tab-info] {
            display: none;
        }
 
        .active[data-tab-info] {
            display: block;
        }
 
        .tab-content {
            font-size: 20px;
            font-family: sans-serif;
            font-weight: bold;
            color: rgb(0, 0, 0);
        }
 
        .tabs {
            border-bottom: 1px solid grey;
            font-size: 25px;
            color: rgb(0, 0, 0);
            display: flex;
            margin: 0;
        }
 
        .tabs span {
            background: hsl(300, 50%, 75%);
            padding: 10px;
            border: 1px solid rgb(255, 255, 255);
        }
 
        .tabs span:hover {
            background: hsl(300, 80%, 50%);
            cursor: pointer;
            color: black;
        }	  

    </style>
  </head>
  <body>
    <script>
      function onDragStart(event) {
        event.dataTransfer.setData('text/plain', event.target.id);
        event.currentTarget.style.backgroundColor = 'yellow';          
      }
      function onDragOver(event) {
        event.preventDefault();
      }            
      function onDrop(event) {
        const id = event.dataTransfer.getData('text');
        const draggableElement = document.getElementById(id);
        const dropzone = event.target;
        dropzone.appendChild(draggableElement);
        event.dataTransfer.clearData();                
      }

      function setDates(){
        const now = new Date();
        const checkinDate = document.getElementById('checkinDate');
        checkinDate.value = `${now.getFullYear()}-${(now.getMonth()+1)}-${now.getDate()}`;
        const checkoutDate = document.getElementById('checkoutDate');
        checkoutDate.value = `${now.getFullYear()}-${(now.getMonth()+1)}-${now.getDate() + 7}`;
        const bookingDate = document.getElementById('bookingDate');
        bookingDate.value = `${now.getFullYear()}-${(now.getMonth()+1)}-${now.getDate()}`;
      }

      function dragOverHandler(ev) {
        console.log("File(s) in drop zone");
        // Prevent default behavior (Prevent file from being opened)		
        ev.preventDefault();		
      }

      let currentFiles = [];

      function dropHandler(ev) {
        console.log("File(s) dropped");

        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
		currentFiles.splice(0, currentFiles.length)
		document.getElementById("drop_zone").innerHTML = "";

        if (ev.dataTransfer.items) {
          // Use DataTransferItemList interface to access the file(s)
          [...ev.dataTransfer.items].forEach((item, i) => {
            // If dropped items aren't files, reject them
            if (item.kind === "file") {			
              currentFile = item.getAsFile();
              console.log(`… currentFile[${i}].name = ${currentFile.name}`);			  
			  currentFiles.push(currentFile);
            }
          });
        } else {
          // Use DataTransfer interface to access the file(s)
          [...ev.dataTransfer.files].forEach((file, i) => {
            console.log(`… file[${i}].name = ${file.name}`);
			currentFiles.push(file);
          });
        }
		
		const uploadedFiles = document.createElement('ul');
		currentFiles.map(z => {
			const newFileDetail = document.createElement("li");
			newFileDetail.innerHTML = `${z.name}`;
			newFileDetail.setAttribute('style', 'display: block;'); 
			uploadedFiles.appendChild(newFileDetail);
		});
		document.getElementById("drop_zone").appendChild(uploadedFiles);
      }

      async function getFeedPrice() {
        try {
			const paramsObj = {
			external_id: document.getElementById("orpExternalId").value,
			start_date: document.getElementById("checkinDate").value,
			end_date: document.getElementById("checkoutDate").value,
			booked_date: document.getElementById("bookingDate").value
			};

			const searchParams = new URLSearchParams(paramsObj).toString();
			const requestUrl = `https://google-vr-calculator.district9.info/feed_from_xml?${searchParams}`;
			const formData = new FormData();		  
			currentFiles.forEach(z => {
			console.log(z.name);
			formData.append("upload_files", z);
			});

			const response = await fetch(requestUrl, {
			method: "POST",
			body: formData,
			});

			const result = await response.json();
			const theText = JSON.stringify(result, null, 2);		
			console.log(theText);
			let content = document.createElement("PRE");
			content.innerHTML = theText;
			document.getElementById("resultsPane").innerHTML = "";
			document.getElementById("resultsPane").appendChild(content);
			formatResults(result);
        } catch (error) {
          console.error(error);
		  let errorMessage = document.createElement("PRE");
		  errorMessage.innerHTML = error;
		  document.getElementById("resultsPane").innerHTML = "";		  
		  document.getElementById("resultsPane").appendChild(errorMessage);
        }
      }
	  
	  function createRateModificationDetails(rateModDetails) {
		const rateModsDiv = document.getElementById("rateModDetails");
		rateModsDiv.innerHTML = "";
		
		const headerTaxFeeRow = document.createElement("div");
		headerTaxFeeRow.style.display = "flex";
		headerTaxFeeRow.style.flexDirection = "row";
		
		const multiplierHeader = document.createElement("span");
		multiplierHeader.innerHTML = "Multiplier";
		multiplierHeader.style.width = "10%";
		headerTaxFeeRow.appendChild(multiplierHeader);
		
		rateModsDiv.appendChild(headerTaxFeeRow);		
		rateModDetails.forEach(z => {
			const newRow = document.createElement("div");
			newRow.style.display = "flex";
			newRow.style.flex_direction = "row";

			const multiplier = document.createElement("span");
			multiplier.style.width = "10%";
			multiplier.innerHTML = z.multiplier;
			newRow.appendChild(multiplier);

			rateModsDiv.appendChild(newRow);
		});						
	  }	  
	  
	  function createTaxFeeDetails(taxFeeDetails, divId) {
		const taxFeeDiv = document.getElementById(divId);
		taxFeeDiv.innerHTML = "";
		
		const headerTaxFeeRow = document.createElement("div");
		headerTaxFeeRow.style.display = "flex";
		headerTaxFeeRow.style.flexDirection = "row";
		
		const calcTypeHeader = document.createElement("span");
		calcTypeHeader.innerHTML = "Calc Type";
		calcTypeHeader.style.width = "10%";
		headerTaxFeeRow.appendChild(calcTypeHeader);
		const periodHeader = document.createElement("span");
		periodHeader.innerHTML = "Period";
		periodHeader.style.width = "20%";
		headerTaxFeeRow.appendChild(periodHeader);
		const amountHeader = document.createElement("span");
		amountHeader.style.width = "20%";
		amountHeader.innerHTML = "Amount";
		headerTaxFeeRow.appendChild(amountHeader);		
		
		taxFeeDiv.appendChild(headerTaxFeeRow);		
		taxFeeDetails.forEach(z => {
			const newRow = document.createElement("div");
			newRow.style.display = "flex";
			newRow.style.flex_direction = "row";

			const calcType = document.createElement("span");
			calcType.style.width = "10%";
			calcType.innerHTML = z.calc_type;
			newRow.appendChild(calcType);

			const period = document.createElement("span");
			period.style.width = "20%";
			period.innerHTML = z.period;
			newRow.appendChild(period);

			const amount = document.createElement("span");
			amount.style.width = "20%";
			amount.innerHTML = z.amount;
			newRow.appendChild(amount);

			taxFeeDiv.appendChild(newRow);
		});						
	  }

	  function createPromotionDetails(promotionDetails) {
		const promotionDiv = document.getElementById("promotionDetails");
		promotionDiv.innerHTML = "";
		
		const headerPromotionRow = document.createElement("div");
		headerPromotionRow.style.display = "flex";
		headerPromotionRow.style.flexDirection = "row";
		
		const idHeader = document.createElement("span");
		idHeader.innerHTML = "Id";
		idHeader.style.width = "10%";
		headerPromotionRow.appendChild(idHeader);
		const percentageHeader = document.createElement("span");
		percentageHeader.innerHTML = "Percentage";
		percentageHeader.style.width = "20%";
		headerPromotionRow.appendChild(percentageHeader);
		const fixedAmountHeader = document.createElement("span");
		fixedAmountHeader.style.width = "20%";
		fixedAmountHeader.innerHTML = "Fixed Amount";
		headerPromotionRow.appendChild(fixedAmountHeader);
		const fixedAmountPerNightHeader = document.createElement("span");
		fixedAmountPerNightHeader.style.width = "10%";
		fixedAmountPerNightHeader.innerHTML = "Fixed Amount Per Night";
		headerPromotionRow.appendChild(fixedAmountPerNightHeader);		
		const fixedPriceHeader = document.createElement("span");
		fixedPriceHeader.style.width = "10%";
		fixedPriceHeader.innerHTML = "Fixed Price";
		headerPromotionRow.appendChild(fixedPriceHeader);		

		promotionDiv.appendChild(headerPromotionRow);
		
		promotionDetails.forEach(z => {
			const newRow = document.createElement("div");
			newRow.style.display = "flex";
			newRow.style.flex_direction = "row";

			const promotionId = document.createElement("span");
			promotionId.style.width = "10%";
			promotionId.innerHTML = z.promotion_id;
			newRow.appendChild(promotionId);

			const percentage = document.createElement("span");
			percentage.style.width = "20%";
			percentage.innerHTML = z.percentage;
			newRow.appendChild(percentage);

			const fixedAmount = document.createElement("span");
			fixedAmount.style.width = "20%";
			fixedAmount.innerHTML = z.fixed_amount;
			newRow.appendChild(fixedAmount);

			const fixedAmountPerNight = document.createElement("span");
			fixedAmountPerNight.style.width = "10%";
			fixedAmountPerNight.innerHTML = z.fixed_amount_per_night;
			newRow.appendChild(fixedAmountPerNight);

			const fixedPrice = document.createElement("span");
			fixedPrice.style.width = "10%";
			fixedPrice.innerHTML = z.fixed_price;
			newRow.appendChild(fixedPrice);

			promotionDiv.appendChild(newRow);
		});	  
	  }


	  function createRentDetails(rentDetails) {
		const rentDiv = document.getElementById("rentDetails");
		rentDiv.innerHTML = "";
		
		const headerRentRow = document.createElement("div");
		headerRentRow.style.display = "flex";
		headerRentRow.style.flexDirection = "row";
		
		const currentDayHeader = document.createElement("span");
		currentDayHeader.innerHTML = "Current Day";
		currentDayHeader.style.width = "10%";
		headerRentRow.appendChild(currentDayHeader);
		const startDayHeader = document.createElement("span");
		startDayHeader.innerHTML = "Start Day";
		startDayHeader.style.width = "20%";
		headerRentRow.appendChild(startDayHeader);
		const endDayHeader = document.createElement("span");
		endDayHeader.style.width = "20%";
		endDayHeader.innerHTML = "End Day";
		headerRentRow.appendChild(endDayHeader);
		const baseAmountHeader = document.createElement("span");
		baseAmountHeader.style.width = "10%";
		baseAmountHeader.innerHTML = "Base Amount";
		headerRentRow.appendChild(baseAmountHeader);		
		rentDiv.appendChild(headerRentRow);
		
		rentDetails.forEach(z => {
			const newRow = document.createElement("div");
			newRow.style.display = "flex";
			newRow.style.flex_direction = "row";

			const currentDay = document.createElement("span");
			currentDay.style.width = "10%";
			currentDay.innerHTML = z.current_day;
			newRow.appendChild(currentDay);

			const startDay = document.createElement("span");
			startDay.style.width = "20%";
			startDay.innerHTML = z.start;
			newRow.appendChild(startDay);

			const endDay = document.createElement("span");
			endDay.style.width = "20%";
			endDay.innerHTML = z.end;
			newRow.appendChild(endDay);

			const baseAmount = document.createElement("span");
			baseAmount.style.width = "10%";
			baseAmount.innerHTML = z.base_amount;
			newRow.appendChild(baseAmount);
			rentDiv.appendChild(newRow);
		});	  
	  }
	  

	  function formatResults(responseJSON) {
		if (!responseJSON.hasOwnProperty("details")) {
			return;
		}
		
		document.getElementById("startDate").innerHTML = responseJSON.details.start_date;
		document.getElementById("endDate").innerHTML = responseJSON.details.end_date;
		
		document.getElementById("nights").innerHTML = responseJSON.details.nights;
		document.getElementById("rentAmount").innerHTML = responseJSON.rent;
		document.getElementById("promotionsAmount").innerHTML = responseJSON.promotions;
		document.getElementById("rateModAmount").innerHTML = responseJSON.rate_modifiers;
		document.getElementById("taxesAndFeesAmount").innerHTML = responseJSON.taxes_and_fees;
		document.getElementById("totalAmount").innerHTML = responseJSON.total;
		
		createRentDetails(responseJSON.details.rent);
		createTaxFeeDetails(responseJSON.details.taxes, "taxDetails");
		createTaxFeeDetails(responseJSON.details.fees, "feeDetails");
		createPromotionDetails(responseJSON.details.promotions);
		createRateModificationDetails(responseJSON.details.rate_modifiers);		
	  };

	  function setupTabs() {
		// function to get each tab details
		const tabs = document.querySelectorAll('[data-tab-value]')
		const tabInfos = document.querySelectorAll('[data-tab-info]')

		tabs.forEach(tab => {
			tab.addEventListener('click', () => {
				const target = document.querySelector(tab.dataset.tabValue);
				tabInfos.forEach(tabInfo => {
					tabInfo.classList.remove('active')
				})
				target.classList.add('active');
			})
		});	  
	  }

      window.onload = (event) => {
        setDates();		
		setupTabs();
      };

    </script>

    <div class="example-parent">
      <div class="example-origin">
        <div style="margin-top: 1rem;">
          <span style="width: 10rem; display: block;">ORP External Id</span>
          <input id="orpExternalId" type="text" placeholder="orp12345x"/>
        </div>
        <div style="margin-top: 1rem;">
          <span style="width: 10rem; display: block;">Checkin Date</span>
          <input id="checkinDate" type="date" />
        </div>
        <div style="margin-top: 1rem;">
          <span style="width: 10rem; display: block;">Checkout Date</span>
          <input id="checkoutDate" type="date" />
        </div>
        <div style="margin-top: 1rem;">
          <span style="width: 10rem; display: block;">Booking Date</span>
          <input id="bookingDate" type="date" />
        </div>
        <div style="margin-top: 1rem;">
          <input id="getFeedPrice" type="button" value="Get Feed Price" onclick="getFeedPrice()" />
        </div>
      </div>
      <div class="example-dropzone" id="drop_zone"
        ondrop="dropHandler(event);"
        ondragover="dragOverHandler(event);">
        <p>Drag and drop the ARI XML files <i>here</i>.</p>
      </div>          
    </div>
	<div class="container">	
		<div class="tabs">
            <span data-tab-value="#tab_1">Formatted Results</span>
            <span data-tab-value="#tab_2">Raw Results</span>
        </div>
		<div class="tab-content">
			<div class="tabs__tab active" id="tab_1" data-tab-info>
				<div class="example-results">
				  <div class="bigHeaderDetail"><h2>Details</h2></div>
				  <div id="tableHeaderRow">
					<div id="resultsRange">
						<div>
							<div style="display: flex; flex-direction: row;">
								<span style="width: 10%;">Start Date</span>
								<span id="startDate"></span>
							</div>
							<div style="display: flex; flex-direction: row;">
								<span style="width: 10%;">End Date</span>
								<span id="endDate"></span>
							</div>
						</div>
						<div class="spacer"></div>
						<div>
							<div style="display: flex; flex-direction: row;">
								<span style="width: 10%;">Nights</span>
								<span id="nights"></span>
							</div>						
							<div style="display: flex; flex-direction: row;">
								<span style="width: 10%;">Rent</span>
								<span id="rentAmount"></span>
							</div>
							<div style="display: flex; flex-direction: row;">
								<span style="width: 10%;">Promotions</span>
								<span id="promotionsAmount"></span>
							</div>
							<div style="display: flex; flex-direction: row;">
								<span style="width: 10%;">Rate Modifiers</span>
								<span id="rateModAmount"></span>
							</div>				
							<div style="display: flex; flex-direction: row;">
								<span style="width: 10%;">Taxes and Fees</span>
								<span id="taxesAndFeesAmount"></span>
							</div>								
							<div style="display: flex; flex-direction: row;">
								<span style="width: 10%;">Total</span>
								<span id="totalAmount"></span>
							</div>				
						</div>
						<div class="spacer"></div>
						<div class="headerDetail"><h3>Rent Details</h3></div>
						<div id="rentDetails">
						</div>
						<div class="spacer"></div>
						<div class="headerDetail"><h3>Promotion Details</h3></div>
						<div id="promotionDetails">
						</div>
						<div class="spacer"></div>
						<div class="headerDetail"><h3>Rate Modification Details</h3></div>
						<div id="rateModDetails">
						</div>			
						<div class="spacer"></div>
						<div class="headerDetail"><h3>Tax Details</h3></div>
						<div id="taxDetails">
						</div>
						<div class="spacer"></div>
						<div class="headerDetail"><h3>Fee Details</h3></div>			
						<div id="feeDetails">
						</div>			
					</div>
				  </div>
				  <div id="tablePane">
				  </div>
				</div>			
			</div>
			<div class="tabs__tab" id="tab_2" data-tab-info>
				<div class="example-results">
				  <div class="bigHeaderDetail"><h2>Response Data</h2></div>
				  <div id="resultsPane"></div>
				</div>		
			</div>
		</div>
	</div>
  </body>
</html>