<!DOCTYPE html>
<html>
<head>
    <title>Google Vacation Rental Calculator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☄️</text></svg>">
    <style>
        .example-results {
            border: 2px solid #0a64b8;
            color: black;
            display: flex;
            font-family: sans-serif;
            font-weight: bold;
            display: flex;
            flex-direction: column;
        }

        .example-parent {
            border: 2px solid #DFA612;
            color: black;
            display: flex;
            font-family: sans-serif;
            font-weight: bold;
            margin: 1rem;
        }

        .example-origin {
            flex-basis: 50%;
            flex-grow: 1;
            padding: 10px;
            display: flex;
            flex-flow: column;
        }

        .example-draggable {
            background-color: #4AAE9B;
            font-weight: normal;
            margin-bottom: 10px;
            margin-top: 10px;
            padding: 10px;
        }

        .example-dropzone {
            display: flex;
            justify-content: center;
            flex-flow: column;
            background-color: hsl(138, 100%, 50%);
            flex-basis: 100%;
            flex-grow: 1;
            padding: 10px;
        }

        .example-dropzone:hover {
            font-weight: bold;
            color: yellow;
            background-color: hsl(240, 100%, 50%);
        }

        .spacer {
            height: 1rem;
        }

        .headerDetail {
            background-color: hsl(74, 82%, 48%);
            overflow: hidden;
        }

        .bigHeaderDetail {
            background-color: hsl(45, 50%, 50%);
        }

        .container {
            border: 1px solid grey;
            margin: 1rem;
        }

        [data-tab-info] {
            display: none;
        }

        .active[data-tab-info] {
            display: block;
        }

        .tab-content {
            font-size: 20px;
            font-family: sans-serif;
            font-weight: bold;
            color: rgb(0, 0, 0);
        }

        .tabs {
            border-bottom: 1px solid grey;
            font-size: 25px;
            color: rgb(0, 0, 0);
            display: flex;
            margin: 0;
        }

        .tabs span {
            background: hsl(277, 94%, 75%);
            padding: 10px;
            border: 1px solid rgb(255, 255, 255);
        }

        .tabs span:hover {
            background: hsl(48, 97%, 56%);
            cursor: pointer;
            color: black;
        }

        pre {
            text-wrap: pretty;
        }

        #calendar {
            max-width: 600px;
        }

        .empty {
            display: none;
        }

        .month {
            padding-top: .5rem;
            padding-bottom: .5rem;
            width: 100%;
            background: hsl(0, 0%, 0%);
            text-align: center;
        }

        .month summary {
            list-style-type: none;
        }

        ul {
            list-style-type: none;
        }

        .month ul {
            margin: 0;
            padding: 0;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr;
        }

        .month ul li {
            color: white;
            font-size: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        #days {
            padding: 10px 0;
            background: hsl(40, 10%, 94%);
            margin: 0;
        }

        #days li {
            list-style-type: none;
            text-align: center;
            font-size: 16px;
            color: #777;
            padding: 15px;
            margin: 3px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        #days li.empty {
            border: none;
            cursor: default;
        }

        #days li.active {
            background: hsl(261, 92%, 51%);
            color: white !important;
        }

        .unavailable {
            background-color: red !important;
            color: white !important;
        }

        #next,
        #prev {
            cursor: pointer;
        }


        #days,
        #weekdays {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr;
        }

        @media all and (-ms-high-contrast: none) {
            #days {
                display: -ms-grid;
                -ms-grid-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
                -ms-grid-rows: 1fr 1fr 1fr 1fr 1fr 1fr;
            }
        }

        .headerDivRow {
            background-color: hsl(337, 73%, 84%);
            display: flex;
            flex-direction: row;
        }

        .striping {
            background-color: hsl(0, 0%, 90%)
        }

        .rowData {
            font-weight: normal;
        }

        .summaryPane {
            display: flex;
            flex-direction: row;
        }

        .leftSummaryPane {
            width: 70%;
        }

        .rightSummaryPane {
            width: 30%;
        }

        .headerDivBlock {
            width: 15%;
        }

        .mapboxgl-popup {
            max-width: 200px;
        }

        .mapboxgl-popup-content {
            text-align: center;
            font-family: monospace, sans-serif;
        }

        .map {
            width: -webkit-fill-available;
        }

    </style>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
</head>
<body>
<script>
    function onDragStart(event) {
        event.dataTransfer.setData('text/plain', event.target.id);
        event.currentTarget.style.backgroundColor = 'yellow';
    }

    function onDragOver(event) {
        event.preventDefault();
    }

    function onDrop(event) {
        const id = event.dataTransfer.getData('text');
        const draggableElement = document.getElementById(id);
        const dropzone = event.target;
        dropzone.appendChild(draggableElement);
        event.dataTransfer.clearData();
    }

    function setDates() {
        const now = new Date();
        const checkinDate = document.getElementById('checkinDate');
        checkinDate.onchange = (evt) => {
            const newStart = new Date(Date.parse(evt.target.value));
            month = newStart.getMonth();
            year = newStart.getFullYear();
        };
        checkinDate.onblur = (evt) => {
            showCalendar(month, year, calendarDates);
        };

        now.setMonth(now.getMonth() + 1);
        checkinDate.value = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        const checkoutDate = document.getElementById('checkoutDate');
        now.setDate(now.getDate() + 7);
        checkoutDate.value = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
        const bookingDate = document.getElementById('bookingDate');
        const bookDay = new Date();
        bookingDate.value = `${bookDay.getFullYear()}-${(bookDay.getMonth() + 1).toString().padStart(2, '0')}-${bookDay.getDate().toString().padStart(2, '0')}`;
    }

    function dragOverHandler(ev) {
        console.log("File(s) in drop zone");
        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
    }

    let currentFiles = [];

    let today = new Date();
    let dayInt = today.getDate();
    let month = today.getMonth();
    let year = today.getFullYear();

    let map = null;
    let mapMarkers = [];

    const months = [
        "January",
        "February",
        "March",
        "April",
        "May",
        "June",
        "July",
        "August",
        "September",
        "October",
        "November",
        "December"
    ];

    let calendarDates = []

    // Modified from https://davidwalsh.name/convert-xml-json
    function xmlToJson(xmlDoc) {
        // Create the return object
        let parsedResult = {};

        if (xmlDoc.nodeType == 1) { // element
            // do attributes
            if (xmlDoc.attributes.length > 0) {
                parsedResult["@attributes"] = {};
                for (let j = 0; j < xmlDoc.attributes.length; j++) {
                    const attribute = xmlDoc.attributes.item(j);
                    parsedResult["@attributes"][attribute.nodeName] = attribute.nodeValue;
                }
            }
        } else if (xmlDoc.nodeType == 3) { // text
            parsedResult = xmlDoc.nodeValue;
        }

        // do children
        if (xmlDoc.hasChildNodes()) {
            for (let i = 0; i < xmlDoc.childNodes.length; i++) {
                const item = xmlDoc.childNodes.item(i);
                const nodeName = item.nodeName;
                if (typeof (parsedResult[nodeName]) == "undefined") {
                    parsedResult[nodeName] = xmlToJson(item);
                } else {
                    if (typeof (parsedResult[nodeName].push) == "undefined") {
                        const old = parsedResult[nodeName];
                        parsedResult[nodeName] = [];
                        parsedResult[nodeName].push(old);
                    }
                    parsedResult[nodeName].push(xmlToJson(item));
                }
            }
        }
        return parsedResult;
    };

    function getCalendarDates(inventories) {
        if (inventories.length == 0) {
            return;
        }

        const calendarDates = [];
        const dayInSeconds = 86400000;
        inventories.forEach((z) => {
            let currentDay = z.Start;
            while (currentDay < z.End) {
                calendarDates.push({
                    Day: new Date(currentDay.getTime() + dayInSeconds), // Shift 1 day
                    Available: z.Available
                });
                currentDay = new Date(currentDay.getTime() + dayInSeconds);
            }
        });
        return calendarDates;
    }

    function parseInventoryData(inventoryData) {

        const inventories = inventoryData.OTA_HotelInvCountNotifRQ.Inventories;
        const propertyId = inventories['@attributes'].HotelCode;
        document.getElementById("orpExternalId").value = propertyId;

        const currentInventories = inventories.Inventory.map((z) => {
            const theDates = z.StatusApplicationControl["@attributes"];
            const counts = z.InvCounts.InvCount["@attributes"];
            return {
                Start: new Date(Date.parse(theDates.Start)),
                End: new Date(Date.parse(theDates.End)),
                Available: parseInt(counts.Count) > 0 ? true : false
            };
        });

        calendarDates = getCalendarDates(currentInventories);
        showCalendar(month, year, calendarDates);
    }

    function readXmlFileContents(fileText, parseFunction) {
        if (fileText.length == 0) {
            return;
        }
        try {
            const parser = new DOMParser();
            const xml = parser.parseFromString(fileText, "text/xml");
            const resultObject = xmlToJson(xml);
            parseFunction(resultObject);
        } catch (err) {
            console.log(err);
        }
    }

    function readInventoryFiles() {
        if (currentFiles.length == 1 && currentFiles[0].name.endsWith(".zip")) {
            extractZipFile(currentFiles[0]);
            return;
        }
        const inventoryFiles = currentFiles.filter(z => z.name.includes("ari_ota_hotel_inv_count_notif"));
        if (inventoryFiles.length == 0) {
            return;
        }

        const inventoryFile = inventoryFiles.pop();
        const reader = new FileReader();
        reader.readAsText(inventoryFile);
        reader.onload = () => {
            const result = reader.result;
            readXmlFileContents(result, parseInventoryData);
        };
    }

    function customDateTimeParse(dateTimeText) {
        const regex = /^(?<year>\d{4})-(?<month>\d{2})-(?<day>\d{2})/gm;
        const match = regex.exec(dateTimeText).groups;
        return new Date(parseInt(match.year), parseInt(match.month) - 1, parseInt(match.day))
    }

    function setAvailability(inventories) {
        calendarDates = getCalendarDates(inventories.map((z) => {
                return {
                    Start: customDateTimeParse(z.start),
                    End: customDateTimeParse(z.end),
                    Available: z.inventory > 0 ? true : false
                }
            }));
        showCalendar(month, year, calendarDates);
        document.getElementById("orpExternalId").value = inventories.pop().external_id;
    }

    function getRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    function updateMap(listings) {
        if (listings.length == 0) {
            return;
        }
        property = listings.shift();
        mapMarkers.forEach(z => z.remove());
        mapMarkers = [];

        const position = [
            property.location.longitude,
            property.location.latitude
        ];

        const title = property.name;
        const addressData = Object.entries(property.address).reduce((a, [k, v]) => (v == null ? a : (a[k] = v, a)), {});
        const addressLine = Object.keys(addressData).reduce((acc, key) => acc + `${addressData[key]} ` ,'');
        const descriptionText = property.description || "";
        const description = descriptionText.length <= 50 ? descriptionText : descriptionText.slice(0, 50);

        const newMarker = new mapboxgl.Marker({ color: getRandomColor() })
            .setLngLat(position)
            .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(`<h3>${title}</h3><p>${addressLine}<br/>${description}</p>`)).addTo(map);
        mapMarkers.push(newMarker);
        map.flyTo({ center: position, zoom: 18 });
    }

    let directPriceUrl = null;

    function updateLandingPage(landingPages) {
        if (landingPages.length == 0) {
            return;
        }
        landingPage = landingPages.shift();
        directPriceUrl = new URL(landingPage.url);
    }

    async function extractZipFile(zipFile) {
        try {
            const formData = new FormData();
            formData.append("upload_file", zipFile);
            const response = await fetch(`https://google-vr-calculator.district9.info/extract_details`, {
                method: "POST",
                body: formData,
            });
            const fileDetails = await response.json();
            if (!response.ok) {
                console.log(fileDetails);
                return;
            }
            const fileDetailText = JSON.stringify(fileDetails, null, 2);
            console.log(fileDetailText);
            setAvailability(fileDetails.Inventory);
            updateMap(fileDetails.Listing);
            updateLandingPage(fileDetails.LandingPage);
        } catch (error) {
            console.error(error);
        }
    }

    function configureUploads() {
        const uploadedFiles = document.createElement('ul');
        currentFiles.map(z => {
            const newFileDetail = document.createElement("li");
            newFileDetail.innerHTML = `${z.name}`;
            newFileDetail.setAttribute('style', 'display: block;');
            uploadedFiles.appendChild(newFileDetail);
        });
        document.getElementById("drop_zone").appendChild(uploadedFiles);
        readInventoryFiles();
    }

    async function loadCachedFile() {
        try {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.length == 0) {
                return;
            }
            const externalId = urlParams.get("external_id");
            const response = await fetch(`https://google-vr-calculator.district9.info/get_property_file?external_id=${externalId}`);
            const zip_file = await response.blob();
            if (!response.ok) {
                console.log(zip_file);
                return;
            }
            if (zip_file.type == "application/json") {
                console.log("No match");
                return;
            }
            const timestamp = (new Date()).getTime();
            const cached_zip_file = new File([zip_file], `${externalId}_${timestamp}.zip`, {type: "application/zip"});
            currentFiles = [];
            currentFiles.push(cached_zip_file);
            configureUploads();

            const arrival = urlParams.get("arrival");
            if (arrival != null) {
                document.getElementById("checkinDate").value = arrival;
            }
            const departure = urlParams.get("departure");
            if (departure != null) {
                document.getElementById("checkoutDate").value = departure;
            }
            setTimeout(() => {
                document.getElementById("getFeedPrice").click();
            }, 250);
        } catch (error) {
            console.error(error);
        }
    }

    function dropHandler(ev) {
        console.log("File(s) dropped");

        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
        currentFiles.splice(0, currentFiles.length)
        document.getElementById("drop_zone").innerHTML = "";

        if (ev.dataTransfer.items) {
            // Use DataTransferItemList interface to access the file(s)
            [...ev.dataTransfer.items].forEach((item, i) => {
                // If dropped items aren't files, reject them
                if (item.kind === "file") {
                    currentFile = item.getAsFile();
                    console.log(`… currentFile[${i}].name = ${currentFile.name}`);
                    currentFiles.push(currentFile);
                }
            });
        } else {
            // Use DataTransfer interface to access the file(s)
            [...ev.dataTransfer.files].forEach((file, i) => {
                console.log(`… file[${i}].name = ${file.name}`);
                currentFiles.push(file);
            });
        }
        configureUploads();
    }

    function createRequestWithData() {
        const paramsObj = {
            external_id: document.getElementById("orpExternalId").value,
            start_date: document.getElementById("checkinDate").value,
            end_date: document.getElementById("checkoutDate").value,
            booked_date: document.getElementById("bookingDate").value
        };

        const searchParams = new URLSearchParams(paramsObj).toString();
        const formData = new FormData();
        let requestUrlMethod = "feed_from_xml";
        if (currentFiles.length == 1 && currentFiles[0].name.endsWith(".zip")) {
            requestUrlMethod = "feed";
            formData.append("upload_file", currentFiles[0]);
        } else {
            currentFiles.forEach(z => {
                console.log(z.name);
                formData.append("upload_files", z);
            });
        }
        return {
            url: `https://google-vr-calculator.district9.info/${requestUrlMethod}?${searchParams}`,
            postData: formData
        }
    }

    function convertXML(inputXML) {
        const replacements = {
            "<": "&lt;",
            ">": "&gt;",
            "\"": "&quot;",
            "'": "&apos;",
            "&": "&amp;",
            "<>": "&lt;&gt;"
        };
        return inputXML.replace(/(&|<|>|\"|'|<>)/gi, (z) => {
            return replacements[z];
        });
    }

    async function getFeedPrice() {

        let targetTab = "formattedTab";
        try {
            var requestDetails = createRequestWithData();
            const response = await fetch(requestDetails.url, {
                method: "POST",
                body: requestDetails.postData,
            });
            if (!response.ok) {
                targetTab = "rawTab";
            }

            const result = await response.json();
            const theText = JSON.stringify(result, null, 2);
            console.log(theText);
            let content = document.createElement("PRE");
            content.innerHTML = convertXML(theText);
            document.getElementById("resultsPane").innerHTML = "";
            document.getElementById("resultsPane").appendChild(content);
            formatResults(result);
            await getDirectPrice();
        } catch (error) {
            console.error(error);
            let errorMessage = document.createElement("PRE");
            errorMessage.innerHTML = error;
            document.getElementById("resultsPane").innerHTML = "";
            document.getElementById("resultsPane").appendChild(errorMessage);
            targetTab = "rawTab";
        }
        document.getElementById(targetTab).click();
    }

    function createDetailSpan(inputDetails) {
        const newSpan = document.createElement("span");
        const defaultDetails = {
            classStyles: [],
            displayText: null,
            width: 0,
        };
        const details = Object.assign(defaultDetails, inputDetails);
        newSpan.style.width = details.width;
        details.classStyles.forEach(z => {
            newSpan.classList.add(z);
        });
        newSpan.innerHTML = details.displayText;
        return newSpan;
    }

    function createRateModificationDetails(rateModDetails) {
        const rateModsDiv = document.getElementById("rateModDetails");
        rateModsDiv.innerHTML = "";

        const headerRateModRow = document.createElement("div");
        headerRateModRow.classList.add("headerDivRow");

        const multiplierHeader = document.createElement("span");
        multiplierHeader.innerHTML = "Multiplier";
        multiplierHeader.style.width = "20%";
        headerRateModRow.appendChild(multiplierHeader);

        rateModsDiv.appendChild(headerRateModRow);
        let rowIndex = 0;
        rateModDetails.forEach(z => {
            const newRow = document.createElement("div");
            newRow.style.display = "flex";
            newRow.style.flex_direction = "row";
            if (rowIndex % 2 == 1) {
                newRow.classList.add("striping");
            }
            newRow.appendChild(createDetailSpan({width: "20%", displayText: `${z.rate_id} ${z.multiplier}`}));
            rateModsDiv.appendChild(newRow);
            rowIndex++;
        });
    }

    function createTaxFeeDetails(taxFeeDetails, divId) {
        const taxFeeDiv = document.getElementById(divId);
        taxFeeDiv.innerHTML = "";

        const headerTaxFeeRow = document.createElement("div");
        headerTaxFeeRow.classList.add("headerDivRow");
        headerTaxFeeRow.appendChild(createDetailSpan({width: "10%", displayText: "Calc Type"}));
        headerTaxFeeRow.appendChild(createDetailSpan({width: "20%", displayText: "Period"}));
        headerTaxFeeRow.appendChild(createDetailSpan({width: "20%", displayText: "Amount"}));

        taxFeeDiv.appendChild(headerTaxFeeRow);
        let rowIndex = 0;
        taxFeeDetails.forEach(z => {
            const newRow = document.createElement("div");
            newRow.style.display = "flex";
            newRow.style.flex_direction = "row";
            if (rowIndex % 2 == 1) {
                newRow.classList.add("striping");
            }
            newRow.appendChild(createDetailSpan({width: "10%", displayText: z.calc_type, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "20%", displayText: z.period, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "20%", displayText: z.amount, classStyles: ["rowData"]}));
            taxFeeDiv.appendChild(newRow);
            rowIndex++;
        });
    }

    function createPromotionDetails(promotionDetails) {
        const promotionDiv = document.getElementById("promotionDetails");
        promotionDiv.innerHTML = "";

        const headerPromotionRow = document.createElement("div");
        headerPromotionRow.classList.add("headerDivRow");
        headerPromotionRow.appendChild(createDetailSpan({width: "10%", displayText: "Id"}));
        headerPromotionRow.appendChild(createDetailSpan({width: "20%", displayText: "Percentage"}));
        headerPromotionRow.appendChild(createDetailSpan({width: "20%", displayText: "Fixed Amount"}));
        headerPromotionRow.appendChild(createDetailSpan({width: "20%", displayText: "Fixed Amount Per Night"}));
        headerPromotionRow.appendChild(createDetailSpan({width: "10%", displayText: "Fixed Price"}));
        promotionDiv.appendChild(headerPromotionRow);

        let rowIndex = 0;
        promotionDetails.forEach(z => {
            const newRow = document.createElement("div");
            newRow.style.display = "flex";
            newRow.style.flex_direction = "row";
            if (rowIndex % 2 == 1) {
                newRow.classList.add("striping");
            }
            newRow.appendChild(createDetailSpan({width: "10%", displayText: z.promotion_id, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "20%", displayText: z.percentage, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "20%", displayText: z.fixed_amount, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({
                width: "20%",
                displayText: z.fixed_amount_per_night,
                classStyles: ["rowData"]
            }));
            newRow.appendChild(createDetailSpan({width: "10%", displayText: z.fixed_price, classStyles: ["rowData"]}));
            promotionDiv.appendChild(newRow);
            rowIndex++;
        });
    }

    function createInventoryDetails(inventoryDetails) {
        const inventoryDiv = document.getElementById("inventoryDetails");
        inventoryDiv.innerHTML = "";

        const headerInventoryRow = document.createElement("div");
        headerInventoryRow.classList.add("headerDivRow");
        headerInventoryRow.appendChild(createDetailSpan({width: "10%", displayText: "Current Day"}));
        headerInventoryRow.appendChild(createDetailSpan({width: "20%", displayText: "Start Day"}));
        headerInventoryRow.appendChild(createDetailSpan({width: "20%", displayText: "End Day"}));
        headerInventoryRow.appendChild(createDetailSpan({width: "10%", displayText: "Inventory"}));
        inventoryDiv.appendChild(headerInventoryRow);

        let rowIndex = 0;
        inventoryDetails.forEach(z => {
            const newRow = document.createElement("div");
            newRow.style.display = "flex";
            newRow.style.flex_direction = "row";
            if (rowIndex % 2 == 1) {
                newRow.classList.add("striping");
            }
            newRow.appendChild(createDetailSpan({width: "10%", displayText: z.current_day, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "20%", displayText: z.start, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "20%", displayText: z.end, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "10%", displayText: z.inventory, classStyles: ["rowData"]}));
            if (z.inventory == 0) {
                newRow.style.backgroundColor = "red";
            }
            inventoryDiv.appendChild(newRow);
            rowIndex++;
        });
    }

    function createRentDetails(rentDetails) {
        const rentDiv = document.getElementById("rentDetails");
        rentDiv.innerHTML = "";

        const headerRentRow = document.createElement("div");
        headerRentRow.classList.add("headerDivRow");
        headerRentRow.appendChild(createDetailSpan({width: "10%", displayText: "Current Day"}));
        headerRentRow.appendChild(createDetailSpan({width: "20%", displayText: "Start Day"}));
        headerRentRow.appendChild(createDetailSpan({width: "20%", displayText: "End Day"}));
        headerRentRow.appendChild(createDetailSpan({width: "10%", displayText: "Base Amount"}));
        rentDiv.appendChild(headerRentRow);

        let rowIndex = 0;
        rentDetails.forEach(z => {
            const newRow = document.createElement("div");
            newRow.style.display = "flex";
            newRow.style.flex_direction = "row";
            if (rowIndex % 2 == 1) {
                newRow.classList.add("striping");
            }
            newRow.appendChild(createDetailSpan({width: "10%", displayText: z.current_day, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "20%", displayText: z.start, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "20%", displayText: z.end, classStyles: ["rowData"]}));
            newRow.appendChild(createDetailSpan({width: "10%", displayText: z.base_amount, classStyles: ["rowData"]}));
            if (z.inventory_count == 0) {
                newRow.style.backgroundColor = "red";
            }
            rentDiv.appendChild(newRow);
            rowIndex++;
        });
    }


    function formatResults(responseJSON) {
        if (!responseJSON.hasOwnProperty("details")) {
            return;
        }

        document.getElementById("startDate").innerHTML = responseJSON.details.start_date;
        document.getElementById("endDate").innerHTML = responseJSON.details.end_date;

        document.getElementById("nights").innerHTML = responseJSON.details.nights;
        document.getElementById("rentAmount").innerHTML = responseJSON.rent;
        document.getElementById("promotionsAmount").innerHTML = responseJSON.promotions;
        document.getElementById("rateModAmount").innerHTML = responseJSON.rate_modifiers;
        document.getElementById("taxesAndFeesAmount").innerHTML = responseJSON.taxes_and_fees;
        document.getElementById("totalAmount").innerHTML = responseJSON.total;

        createRentDetails(responseJSON.details.rent);
        createTaxFeeDetails(responseJSON.details.taxes, "taxDetails");
        createTaxFeeDetails(responseJSON.details.fees, "feeDetails");
        createPromotionDetails(responseJSON.details.promotions);
        createRateModificationDetails(responseJSON.details.rate_modifiers);
        createInventoryDetails(responseJSON.details.inventories);
    };

    function setupTabs() {
        // function to get each tab details
        const tabs = document.querySelectorAll('[data-tab-value]')
        const tabInfos = document.querySelectorAll('[data-tab-info]')

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = document.querySelector(tab.dataset.tabValue);
                tabInfos.forEach(tabInfo => {
                    tabInfo.classList.remove('active')
                })
                target.classList.add('active');
            })
        });
    }


    function daysInMonth(month, year) {
        // day 0 here returns the last day of the PREVIOUS month
        return new Date(year, month + 1, 0).getDate();
    }

    function blankDates(count) {
        const calendarDays = document.getElementById("days");
        // looping to add the correct amount of blank days to the calendar
        for (let x = 0; x < count; x++) {
            let cell = document.createElement("li");
            let cellText = document.createTextNode("");
            cell.appendChild(cellText);
            // add the empty class to remove the borders
            cell.classList.add("empty");
            calendarDays.appendChild(cell);
        }
    }

    function isAvailable(currentDay, currentMonth, currentYear, parsedAvailabilities) {
        let isAvailable = true;
        if (parsedAvailabilities.length == 0) {
            return isAvailable;
        }
        for (let i = 0; i < parsedAvailabilities.length; i++) {
            const current = parsedAvailabilities[i];
            if (current.Day.getDate() == currentDay &&
                current.Day.getMonth() == currentMonth &&
                current.Day.getFullYear() == currentYear) {
                isAvailable = current.Available;
                break;
            }
        }
        return isAvailable;
    }

    function showCalendar(month, year, parsedAvailabilities) {
        // gets the day of the week for this date
        let firstDay = new Date(year, month).getDay();
        // clearing all previous cells
        const calendarDays = document.getElementById("days");
        calendarDays.innerHTML = "";
        // checking the mount of days in this month to control the loop
        let totalDays = daysInMonth(month, year);

        // adding the blank boxes so that date start on correct day of the week
        // substracting 1 to set monday as the first weekday
        // and testing for sunday because it became the 7th day
        blankDates(firstDay === 0 ? 6 : firstDay - 1);
        // adding the dates to the calendar
        for (let day = 1; day <= totalDays; day++) {
            // create li node with text content & apend to body
            let cell = document.createElement("li");
            let cellText = document.createTextNode(day);
            // adding active class if day matches today
            if (dayInt === day && month === today.getMonth() && year === today.getFullYear()) {
                cell.classList.add("active");
            }

            // appending date attributes to single date li element
            cell.setAttribute("data-day", day);
            cell.setAttribute("data-month", month);
            cell.setAttribute("data-year", year);
            //appending li to body of calendar
            cell.classList.add("singleDay");

            if (isAvailable(day, month, year, parsedAvailabilities) == false) {
                cell.classList.add("unavailable");
            }

            cell.appendChild(cellText);
            calendarDays.appendChild(cell);
        }
        // set month string value
        document.getElementById("month").innerHTML = months[month];
        // set year string value
        document.getElementById("year").innerHTML = year;
    }

    function next() {
        year = month === 11 ? year + 1 : year;
        month = (month + 1) % 12;
        showCalendar(month, year, calendarDates);
    }

    function previous() {
        year = month === 0 ? year - 1 : year;
        month = month === 0 ? 11 : month - 1;
        showCalendar(month, year, calendarDates);
    }

    function setupCalendar() {
        const nextbtn = document.getElementById("next");
        nextbtn.onclick = function () {
            next();
        };
        const prevBtn = document.getElementById("prev");
        prevBtn.onclick = function () {
            previous();
        };
        showCalendar(month, year, calendarDates);
    }

    function getPriceUrl() {
        let targetUrl = new URL(directPriceUrl);
        const checkIn = document.getElementById('checkinDate').value;
        const checkOut = document.getElementById('checkoutDate').value;
        targetUrl.searchParams.set("or_arrival", checkIn);
        targetUrl.searchParams.set("or_departure", checkOut);
        targetUrl.searchParams.delete("or_children");
        return targetUrl.toString();
    }

    async function getDirectPrice() {
        try {
            if ((directPriceUrl || "").length == 0) {
                return;
            }
            const targetRequest = {
                target_url: getPriceUrl(),
                watermark: "a21d27a5-52e4-44c7-b5f6-dd4698193a99"
            };
            const response = await fetch(`https://headless-horseman.district9.info/retrieve_price`, {
                headers: {
                    "accept": "application/json",
                    "Content-Type": "application/json"
                },
                method: "POST",
                body: JSON.stringify(targetRequest)
            });
            const fileDetails = await response.json();
            if (!response.ok) {
                console.log(fileDetails);
                return;
            }
            const fileDetailText = JSON.stringify(fileDetails, null, 2);
            console.log(fileDetailText);
            const displayPriceDiv = document.getElementById("directPricePane");
            directPricePane.innerHTML = "";
            let content = document.createElement("PRE");
            content.innerHTML = fileDetailText;
            directPricePane.appendChild(content);

            const priceDetail = fileDetails.result;

            if (priceDetail != null) {

                let summary = document.createElement("ul");
                let total = document.createElement("li");
                total.innerText = `Total: ${priceDetail.total}`;
                summary.appendChild(total);

                let nights = document.createElement("li");
                nights.innerText = `Nights: ${priceDetail.nights}`;
                summary.appendChild(nights);

                const displayPriceDiv = document.getElementById("directPriceDiv");
                displayPriceDiv.innerHTML = "";
                displayPriceDiv.appendChild(summary);
            }
        } catch (error) {
            console.error(error);
        }
    }

    function setupMap() {
        mapboxgl.accessToken = "pk.eyJ1Ijoic2lsaWNvbnJvYiIsImEiOiIxOWM1MmVlNGJjNmQ2NjI0ZWY1OTE5Y2QyY2Y1MWI0MCJ9.bp9QpwF5XACrQI4C8NRORQ";
        map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/streets-v12",
            center: [0, 0],
            zoom: 0,
        });
    }

    window.onload = (event) => {
        setDates();
        setupTabs();
        setupCalendar();
        loadCachedFile();
        setupMap();
    };
</script>

<div class="example-parent">
    <div class="example-origin">
        <div style="margin-top: 1rem;">
            <span style="width: 10rem; display: block;">ORP External Id</span>
            <input id="orpExternalId" placeholder="orp12345x" type="text" style="width: 7rem;"/>
        </div>
        <div style="margin-top: 1rem;">
            <span style="width: 10rem; display: block;">Checkin Date</span>
            <input id="checkinDate" type="date"/>
        </div>
        <div style="margin-top: 1rem;">
            <span style="width: 10rem; display: block;">Checkout Date</span>
            <input id="checkoutDate" type="date"/>
        </div>
        <div style="margin-top: 1rem;">
            <span style="width: 10rem; display: block;">Booking Date</span>
            <input id="bookingDate" type="date"/>
        </div>
        <div style="margin-top: 1rem;">
            <input id="getFeedPrice" onclick="getFeedPrice()" type="button" value="Get Feed Price"/>
        </div>
    </div>
    <div class="example-origin">
        <div id="calendar">
            <div class="month">
                <ul>
                    <li id="prev">&#10094;</li>
                    <li id="month"></li>
                    <li id="year"></li>
                    <li id="next">&#10095;</li>
                </ul>
            </div>
            <ul id="days"></ul>
        </div>
    </div>
    <div class="example-dropzone" id="drop_zone"
         ondragover="dragOverHandler(event);"
         ondrop="dropHandler(event);">
        <p>Drag and drop the ARI XML files <i>here</i>.</p>
    </div>
    <div class="map" id="map">
    </div>
</div>
<div class="container">
    <div class="tabs">
        <span data-tab-value="#tab_1" id="formattedTab">Formatted Results</span>
        <span data-tab-value="#tab_2" id="rawTab">Raw Results</span>
        <span data-tab-value="#tab_3" id="directPriceTab">Direct Price Results</span>
    </div>
    <div class="tab-content">
        <div class="tabs__tab active" data-tab-info id="tab_1">
            <div class="example-results">
                <div class="bigHeaderDetail">
                    <div style="display: flex;">
                        <div>
                            <h2>Details</h2>
                        </div>
                    </div>
                </div>
                <div id="tableHeaderRow">
                    <div id="resultsRange">
                        <div class="summaryPane">
                            <div class="leftSummaryPane">
                                <div>
                                    <div style="display: flex; flex-direction: row;">
                                        <span class="headerDivBlock">Start Date</span>
                                        <span class="rowData" id="startDate"></span>
                                    </div>
                                    <div style="display: flex; flex-direction: row;">
                                        <span class="headerDivBlock">End Date</span>
                                        <span class="rowData" id="endDate"></span>
                                    </div>
                                </div>
                                <div class="spacer"></div>
                                <div>
                                    <div style="display: flex; flex-direction: row;">
                                        <span class="headerDivBlock">Nights</span>
                                        <span class="rowData" id="nights"></span>
                                    </div>
                                    <div style="display: flex; flex-direction: row;">
                                        <span class="headerDivBlock">Rent</span>
                                        <span class="rowData" id="rentAmount"></span>
                                    </div>
                                    <div style="display: flex; flex-direction: row;">
                                        <span class="headerDivBlock">Promotions</span>
                                        <span class="rowData" id="promotionsAmount"></span>
                                    </div>
                                    <div style="display: flex; flex-direction: row;">
                                        <span class="headerDivBlock">Rate Modifiers</span>
                                        <span class="rowData" id="rateModAmount"></span>
                                    </div>
                                    <div style="display: flex; flex-direction: row;">
                                        <span class="headerDivBlock">Taxes and Fees</span>
                                        <span class="rowData" id="taxesAndFeesAmount"></span>
                                    </div>
                                    <div style="display: flex; flex-direction: row;">
                                        <span class="headerDivBlock">Total</span>
                                        <span class="rowData" id="totalAmount"></span>
                                    </div>
                                </div>    
                            </div>
                            <div class="rightSummaryPane" >
                                <div id="directPriceDiv">
                                </div>
                            </div>
                        </div>
                        <div class="spacer"></div>
                        <div class="headerDetail"><h3>Rent Details</h3></div>
                        <div id="rentDetails">
                        </div>
                        <div class="spacer"></div>
                        <div class="headerDetail"><h3>Promotion Details</h3></div>
                        <div id="promotionDetails">
                        </div>
                        <div class="spacer"></div>
                        <div class="headerDetail"><h3>Rate Modification Details</h3></div>
                        <div id="rateModDetails">
                        </div>
                        <div class="spacer"></div>
                        <div class="headerDetail"><h3>Tax Details</h3></div>
                        <div id="taxDetails">
                        </div>
                        <div class="spacer"></div>
                        <div class="headerDetail"><h3>Fee Details</h3></div>
                        <div id="feeDetails">
                        </div>
                        <div class="spacer"></div>
                        <div class="headerDetail"><h3>Inventory Details</h3></div>
                        <div id="inventoryDetails">
                        </div>
                    </div>
                </div>
                <div id="tablePane">
                </div>
            </div>
        </div>
        <div class="tabs__tab" data-tab-info id="tab_2">
            <div class="example-results">
                <div class="bigHeaderDetail"><h2>Response Data</h2></div>
                <div id="resultsPane"></div>
            </div>
        </div>
        <div class="tabs__tab" data-tab-info id="tab_3"></div>
            <div class="example-results">
                <div class="bigHeaderDetail"><h2>Direct Price</h2></div>
                <div id="directPricePane"></div>
            </div>
        </div>
    </div>
</div>
</body>
</html>